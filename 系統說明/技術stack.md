# 虛擬太空人互動養成計畫實施方案

## 系統架構概述

虛擬太空人互動養成計畫是一個結合3D模型、語音互動、自然語言處理和記憶系統的藝術裝置專案。系統使用FastAPI + React作為前後端技術架構，PostgreSQL + pgvector作為資料庫系統，Gemini API作為對話模型，並使用LangGraph實現角色記憶系統。

```
+---------------------+    +----------------------+    +-------------------+
|   前端展示層        |    |   後端處理層         |    |   資料存儲層      |
|  (React+Three.js)   |<-->|  (FastAPI+WebSocket) |<-->| (PostgreSQL+pgvector)|
+---------------------+    +----------------------+    +-------------------+
        |                          |                          |
        v                          v                          v
+---------------------+    +----------------------+    +-------------------+
|   Three.js渲染      |    | 語音處理服務 (STT/TTS)|    |   LangGraph       |
|   Morph Target控制  |    | 互動協調模組         |    |   記憶系統        |
|   骨骼動畫控制      |    | Gemini API           |    |   向量檢索        |
+---------------------+    +----------------------+    +-------------------+
```

## 模組拆分與功能

1. **場景管理器**：負責Three.js場景、光源、攝影機的管理（React前端）
2. **骨骼動畫管理器**：管理並動態載入、調度身體動作（React前端）
3. **表情管理器**：管理Morph Target臉部動畫與嘴型（React前端）
4. **語音播放器**：處理語音播放並同步動畫（React前端）
5. **互動協調模組**：協調語音、表情和動作的同步處理（FastAPI後端）
6. **語音辨識服務**：將用戶語音轉換為文字（STT API）
7. **語音合成服務**：將文字回應轉換成語音（TTS API）
8. **記憶管理器**：使用LangGraph + PostgreSQL/pgvector建立角色記憶資料庫（FastAPI後端）
9. **自然語言管理器**：使用Gemini API處理對話（FastAPI後端）

## 技術實現方案

### 前端實現 (React + Three.js + react-three-fiber)

1. **React應用架構**：
   - 使用Create React App或Next.js建立專案
   - 使用React組件管理UI界面
   - 使用WebSocket實現即時通訊
   - 使用React Hooks管理狀態

2. **Three.js整合**：
   - 使用react-three-fiber整合Three.js與React
   - 使用drei庫簡化Three.js常用操作
   - 實現3D場景與模型載入
   - 優化即時渲染性能

3. **動畫與表情**：
   - 使用GLTFLoader載入帶有Morph Target的GLB/GLTF模型
   - 實現表情與動作的狀態管理
   - 透過動畫控制指令同步嘴型與語音
   - 實現流暢的動作過渡

4. **用戶界面**：
   - 設計簡潔的互動界面
   - 實現語音輸入控制
   - 顯示即時對話狀態
   - 提供互動反饋指示

### 後端實現 (FastAPI + WebSocket)

1. **FastAPI架構**：
   - 設計RESTful API端點
   - 實現WebSocket支持即時通訊
   - 使用Pydantic模型進行數據驗證
   - 優化異步處理效能

2. **自然語言處理**：
   - 整合Gemini API處理對話
   - 實現角色人格設定與對話風格
   - 開發情感分析功能
   - 提取意圖與情緒資訊

3. **互動協調模組**：
   - 接收語音辨識轉換的文字
   - 處理Gemini API回應的文字內容
   - 整合TTS語音合成服務
   - 生成同步的表情與動作控制指令
   - 將協調好的語音與動畫信息發送給前端

4. **記憶系統**：
   - 使用LangGraph框架建立記憶管理工作流
   - 使用PostgreSQL + pgvector存儲向量化對話記憶
   - 實現快速記憶檢索
   - 優化記憶存取效能

### 語音處理技術

1. **語音辨識 (STT)**：
   - 使用Google Speech-to-Text或Azure Speech Services
   - 處理展場環境的語音輸入
   - 優化辨識準確度
   - 支援中文輸入處理

2. **語音合成 (TTS)**：
   - 使用Google Text-to-Speech或Azure Neural TTS
   - 生成自然流暢的語音回應
   - 調整語音特性以符合太空人角色
   - 支援音訊文件暫存與播放

### 資料庫設計 (PostgreSQL + pgvector)

1. **資料庫架構**：
   - 使用PostgreSQL作為關聯式資料庫
   - 使用pgvector擴展支持向量搜索
   - 設計適合LLM應用的資料模型

2. **主要資料表**：
   - `conversations`: 存儲對話歷史
   - `memories`: 存儲角色記憶（向量化）
   - `character_states`: 存儲角色狀態和情感
   - `users`: 存儲互動用戶資訊

3. **向量存儲**：
   - 使用pgvector存儲對話和記憶的向量表示
   - 實現相似度搜索以檢索相關記憶
   - 優化向量索引提高檢索效率

### 3D資產與動畫

1. **模型格式**：
   - 使用GLB/GLTF格式的3D模型
   - 包含骨骼結構與蒙皮
   - 整合Morph Targets實現表情變化
   - 優化模型複雜度與效能

2. **動畫系統**：
   - 骨骼動畫控制身體動作
   - Morph Targets控制臉部表情
   - 實現動畫的平滑混合與過渡
   - 開發動畫同步系統

## 互動協調模組設計

### 模組功能
互動協調模組是系統的核心，負責同步處理：
1. **語音輸出控制**：將生成的文字轉換為語音並控制播放
2. **表情動畫控制**：基於文字內容與情緒生成表情變化
3. **身體動畫控制**：根據對話意圖選擇並控制骨骼動畫

### 工作流程
1. 接收STT服務轉換後的文字訊息
2. 將文字傳送給Gemini API處理
3. 分析Gemini回應中的意圖與情緒
4. 生成協調控制指令：包含語音、表情和動作
5. 調用TTS服務生成語音檔案
6. 建立同步時間點，協調各元素的播放時機
7. 將控制訊息發送給前端執行

## 展場互動流程

1. 觀眾進入展場，看到大螢幕上的虛擬太空人
2. 觀眾按下按鈕啟動麥克風，開始語音對話
3. 系統透過STT服務處理語音輸入，轉換為文字
4. Gemini API結合記憶系統生成文字回應
5. 互動協調模組生成並協調語音、表情和動作
6. 前端同步播放TTS語音、表情變化和身體動作
7. 系統將新互動存入記憶系統，持續學習成長

## 開發階段與時程 (2025/04/05 - 2025/07/15)

### 第一階段（4/05 - 4/25）：基礎架構與模型
- 設置React前端與FastAPI後端框架
- 建立WebSocket即時通訊
- 完成太空人3D模型與基本動作
- 建立展場場景

### 第二階段（4/26 - 5/20）：語音與對話
- 實現STT語音辨識與TTS語音合成
- 整合Gemini API
- 開發互動協調模組
- 實現表情與語音同步

### 第三階段（5/21 - 6/15）：記憶系統
- 設計並實現LangGraph記憶工作流
- 整合PostgreSQL/pgvector向量存儲
- 實現角色記憶檢索與更新機制

### 第四階段（6/16 - 7/05）：動作與表情優化
- 深化骨骼動畫與Morph Target控制
- 優化表情與語音同步
- 增強角色表現力

### 第五階段（7/06 - 7/15）：測試與調整
- 進行展場環境測試
- 優化系統性能
- 調整互動體驗

## 資源需求

### 硬體需求
- 展示用大螢幕
- 高品質麥克風系統
- 專業音響設備
- 高效能伺服器（可使用雲端服務）

### 軟體與API
- React（前端框架，免費）
- FastAPI（後端框架，免費）
- Three.js / react-three-fiber（3D渲染，免費）
- PostgreSQL + pgvector（資料庫，免費）
- LangGraph（記憶系統框架，免費）
- Gemini API（約100-150 USD/月）
- STT語音辨識服務（依使用量計費）
- TTS語音合成服務（依使用量計費）

### 人力資源
- React/Three.js前端開發工程師
- FastAPI後端開發工程師
- 3D模型與動畫專家
- AI整合專家
- 資料庫工程師

## 預算估算

- **總預算**：20萬至30萬新台幣
- **藝術家費用**：約6萬至9萬新台幣（佔比約三成）
- **技術開發費用**：約14萬至21萬新台幣（約七成）
- **API與伺服器成本**：每月約4,000至8,000新台幣
