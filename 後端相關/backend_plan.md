# 虛擬太空人互動裝置後端系統開發計畫

## 一、文檔目的與架構
本文件提供虛擬太空人互動裝置的後端系統開發計畫，涵蓋 API 規範設計、WebSocket 通訊規範、服務整合流程、互動協調模組說明，以及開發時程與成本管理。

---

## 二、RESTful API 設計規範

| API 路徑                    | 方法 | 請求參數                          | 回應結構                                   | 說明                              |
|----------------------------|------|----------------------------------|--------------------------------------------|----------------------------------|
| `/api/interaction`         | POST | `{ "user_input": "string" }`   | `{ "reply": "string", "emotion": "string", "intent": "string" }` | 處理語音辨識文字並產生回應內容、情緒與意圖 |
| `/api/memories/{user_id}`  | GET  | 無                               | `[ { "timestamp": "datetime", "interaction": "string" } ]`     | 查詢用戶互動歷史記錄              |
| `/api/status`              | GET  | 無                               | `{ "status": "ok" }`                   | 系統健康狀態檢查                  |

---

## 三、WebSocket 通訊規範（兼容 Socket.IO）

### 連接路徑
- `/ws/interactions`
- 使用 FastAPI 建立與前端 Socket.IO 兼容的即時通訊。

### 訊息格式

前端發送訊息：
```json
{
  "event": "user_input",
  "data": { "text": "string" }
}
```

後端回傳訊息：
```json
{
  "event": "interaction_control",
  "data": {
    "speech_url": "string",
    "speech_duration": "float (seconds)",
    "emotion": "string",
    "animation": "string"
  }
}
```

---

## 四、互動協調模組

### 功能說明
協調語音、表情及動作同步呈現，提升用戶體驗連貫性。

### 工作流程
1. 接收並驗證 Google STT API 輸出的文字。
2. 調用 Google Gemini API 分析情緒與意圖。
3. 根據分析結果制定語音、表情與動作同步方案。
4. 呼叫 Google TTS API 產生語音，取得語音 URL 及時長。
5. 建立精確包含語音時長的播放時間戳。
6. 透過 WebSocket 發送控制指令給前端實現精確同步播放。

---

## 五、錯誤處理與資源管理

### 錯誤訊息規範（配合前端 React Context 狀態管理）

```json
{
  "error": {
    "code": "string",
    "message": "使用者友善的錯誤提示"
  }
}
```

### 語音辨識（STT）錯誤處理
- 設定最多 3 次重試次數，避免使用者體驗惡化。
- 提供錯誤具體指引，例如："請調整麥克風距離或降低背景噪音後再試一次。"

### 語音合成（TTS）資源管理
- 建立語音檔案自動清理機制，每週定期執行清理過期檔案。
- 快取常用語音檔案，減少重複 API 呼叫並節約成本。

---

## 六、開發時程調整

| 階段       | 日期          | 任務                                   |
|------------|---------------|----------------------------------------|
| 第一階段   | 4/05 - 4/25   | FastAPI 基礎建置、WebSocket 通訊開發  |
| 第二階段   | 4/26 - 5/10   | Google Gemini、STT、TTS API 整合測試   |
| 第三階段   | 5/11 - 6/05   | 互動協調模組開發與錯誤處理機制完備化   |
| 第四階段   | 6/06 - 6/25   | 記憶系統整合與效能優化                |
| 第五階段   | 6/26 - 7/15   | 展場實地測試與最後調整                |

調整理由：提前後端整合測試，以確保與前端順暢整合，避免後期開發積壓。

---

## 七、效率提升與成本控制策略
- 建立 API 使用配額與資源消耗監控，精準管理避免超支。
- WebSocket 通訊消息實施壓縮處理，降低網路負載。
- 每月定期檢視運行日誌，優化資源配置。
- 定期進行資料備份與清理，確保系統效能並降低長期成本。

---

經過以上整合與調整，本文件確保前後端順暢協作，明確規範且易於執行，達成專案高效開發與維護的目標。

