# 音效系統功能與擴充指南

## 1. 系統概述

音效系統是我們太空中心對話互動體驗的重要組成部分，旨在提供類似「直播網紅」和「綜藝樂隊」的聽覺體驗，增強對話的戲劇性和趣味性。目前音效系統主要由以下部分組成：

- **後端音效節點** (`SoundEffectNode`): 分析對話內容，決定適合的音效類型
- **後端音效服務** (`SoundEffectService`): 生成具體的音效命令
- **前端音效服務** (`SoundEffectService.ts`): 接收並執行音效命令，實際播放聲音

## 2. 音效系統工作流程

### 2.1 音效生成流程

1. 使用者發送訊息，AI 生成回覆
2. 對話節點處理完成後，將結果（包含 AI 回應文本）傳遞給音效節點 `SoundEffectNode`
3. 音效節點進行文本分析，提取關鍵詞和特徵，決定音效模式（如 excited, serious, question 等）和強度
4. 音效節點調用 `SoundEffectService.create_tone_sequence()` 方法，生成 Tone.js 可用的音效命令
5. 音效命令通過 WebSocket 連接發送到前端
6. 前端的 `WebSocketService` 接收到 `audio-effect` 類型的消息，轉發給 `SoundEffectService.ts`
7. 前端音效服務解析命令，使用 Web Audio API 和 Tone.js 實際播放音效

### 2.2 資料流圖

```
[使用者] <--> [前端UI] <--> [後端Dialogue節點]
                               |
                               v
                        [SoundEffectNode]  
                               |
                               v
                      [SoundEffectService]
                               |
                               v
[WebAudio/Tone.js] <-- [WebSocketService] <-- [WebSocket API]
```

## 3. 後端音效系統詳解

### 3.1 SoundEffectNode (音效節點)

位置: `prototype/backend/services/ai/graph_nodes/sound_effect_node.py`

功能:
- 接收對話結果，進行非同步處理
- 分析文本以確定合適的音效特徵
- 使用正則表達式匹配關鍵詞/短語
- 計算音效強度 (intensity)，考慮感嘆號數量和文本情感
- 選擇最適合的音效模式
- 調用音效服務生成具體的音效命令

支持的模式判斷:
- `excited`: 興奮模式，上升音階
- `serious`: 嚴肅模式，下降音階
- `question`: 疑問模式，上升語調
- `thinking`: 思考模式，慢節奏
- `success`: 成功模式，歡快音效
- `important`: 重要信息模式，強調音效
- `tech`: 科技相關模式，數字化聲音
- `space`: 太空相關模式，環境聲
- `funny`: 滑稽/捧哏模式
- `fail`: 失敗模式，下滑音
- `surprise`: 驚訝模式
- `neutral`: 中性模式（預設）

### 3.2 SoundEffectService (音效服務)

位置: `prototype/backend/services/sound_effect/sound_effect_service.py`

功能:
- 提供靜態方法用於創建各種音效命令
- `create_synth_sound_command()`: 核心方法，創建合成音效命令
- `create_tone_sequence()`: 根據指定模式創建音效序列
- `create_background_music_command()`: 創建背景音樂命令
- `create_ambient_sound_effects()`: 創建環境音效
- `create_greeting_sound()`: 創建歡迎音效

音效命令格式:
```json
{
  "type": "audio-effect",
  "payload": {
    "synthMode": true,
    "effects": [
      {
        "type": "beep",
        "options": {
          "frequency": 440,
          "duration": 0.1,
          "volume": 0.5,
          "wavetype": "sine"
        },
        "startTime": 0
      },
      // 更多音效...
    ]
  }
}
```

## 4. 前端音效系統詳解

### 4.1 WebSocketService (WebSocket服務)

位置: `prototype/frontend/src/services/WebSocketService.ts`

功能:
- 建立與後端的 WebSocket 連接
- 接收各種類型的消息，包括 audio-effect
- 當收到 audio-effect 類型消息時，轉發給 SoundEffectService

### 4.2 SoundEffectService (前端音效服務)

位置: `prototype/frontend/src/services/SoundEffectService.ts`

功能:
- 使用 Web Audio API 和 Tone.js 播放各種音效
- `playSynthSequence()`: 播放合成音效序列
- `playSoundEffectFromCommand()`: 從命令對象播放音效
- 支持 beep（音調）和 noise（噪音）兩種基本音效類型
- 管理音頻上下文，處理瀏覽器音頻策略限制

## 5. 音效系統當前問題與限制

1. **觸發問題**：目前音效只在對話開始時偶爾觸發，不能在對話中的關鍵點持續提供音效反饋。
2. **同步問題**：音效生成與發送可能存在時機問題，導致前端無法收到或正確處理。
3. **模式豐富度**：雖然已定義多種音效模式，但實際觸發和表現力仍有提升空間。
4. **互動性不足**：缺乏與使用者輸入直接對應的音效反饋機制。

## 6. 擴充方向與建議

### 6.1 架構改進

1. **直接與對話流程整合**：在對話節點處理過程中，可以直接嵌入音效判斷與生成，而不是作為後處理步驟。
2. **即時音效反饋**：為對話的不同階段添加專屬音效（開始輸入、思考中、回覆開始、回覆完成等）。
3. **音效事件系統**：建立基於事件的音效觸發機制，讓系統中的各個環節都能觸發相應音效。

### 6.2 音效內容擴充

1. **更多音效模式**：增加更多特色音效，如「神秘」、「戲劇化」、「懸疑」等。
2. **隨機變化**：為同一音效模式添加多種變體，避免重複聽感。
3. **音效組合**：允許多種音效模式組合，創造更豐富的聽覺體驗。
4. **背景音樂與環境音**：加強背景音樂系統，根據對話內容動態調整背景音樂氛圍。

### 6.3 用戶互動增強

1. **用戶發言觸發**：分析用戶輸入文本，為其添加相應音效（例如用戶問問題時播放疑問音效）。
2. **關鍵詞觸發**：定義特殊關鍵詞，當出現時播放特定音效（如提到「火箭」時播放發射音效）。
3. **音效個性化**：允許用戶選擇或自定義音效風格。

### 6.4 性能與穩定性

1. **音效優先級系統**：當需要同時播放多個音效時，基於優先級決定播放順序。
2. **降級策略**：在設備性能不足或網絡延遲高的情況下，自動簡化音效複雜度。
3. **緩存機制**：常用音效可以在前端緩存，減少網絡傳輸。

## 7. 實施方案

### 7.1 短期改進計劃

1. **修復音效觸發**：確保 WebSocket 正確傳輸音效命令，並在前端正確處理。
2. **增加觸發點**：在對話流程的多個關鍵點添加音效觸發。
3. **豐富音效庫**：擴展現有音效模式，增加變體和組合。
4. **日誌優化**：完善音效系統的日誌，便於排查問題。

### 7.2 中長期改進計劃

1. **音效引擎重構**：考慮採用更先進的音效引擎或庫。
2. **AI驅動音效**：使用機器學習模型分析對話內容和情緒，自動生成最合適的音效。
3. **用戶反饋整合**：收集用戶對音效的反饋，持續優化音效體驗。
4. **跨平台適配**：確保音效系統在不同設備和瀏覽器上表現一致。

## 8. 開發者指南

### 8.1 添加新音效模式

1. 在 `SoundEffectService.create_tone_sequence()` 方法中定義新模式
2. 在 `SoundEffectNode._compile_patterns()` 中添加對應的正則表達式模式
3. 在 `SoundEffectNode._analyze_text_for_sound_profile()` 的模式選擇邏輯中加入新模式判斷

### 8.2 測試音效

可以通過以下方式測試音效系統：

1. 後端直接調用 `SoundEffectService` 方法生成音效命令，通過日誌檢查格式
2. 在 WebSocket 端點手動構造並發送音效命令
3. 在前端開發者控制台中直接調用 `SoundEffectService` 的方法播放音效

### 8.3 常見問題排查

1. **無法聽到音效**：
   - 檢查瀏覽器音頻設置
   - 檢查 WebSocket 連接是否正常
   - 檢查前端控制台是否有音頻相關錯誤
   - 確認音效命令格式正確

2. **音效播放延遲**：
   - 檢查網絡延遲
   - 檢查音效處理流程是否有阻塞操作

3. **音效不匹配內容**：
   - 檢查文本分析邏輯
   - 調整正則表達式匹配規則
   - 微調模式選擇優先級

## 9. 結論

音效系統為太空中心對話體驗增添了聽覺維度，使互動更加豐富和引人入勝。通過持續改進和擴展，我們可以逐步實現類似「直播網紅」和「綜藝樂隊」的音效體驗，為用戶創造更加沉浸式的互動環境。 