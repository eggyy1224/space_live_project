# 0406 前端重構 TODO List

本文檔基於對專案現狀的分析和未來規劃，旨在指導前端部分的漸進式重構，以構建一個穩定、高效、可擴展且能生動體現 AI 角色特質的前端系統。

參考文件：
- [專案總覽與願景 (README.md)](../../README.md)
- [現有前端架構分析 (docs/前端相關/0402前端架構.md)](../前端相關/0402前端架構.md)
- [前端效能問題分析 (docs/refactor_docs/0402前端效能問題分析與優化建議.md)](./0402前端效能問題分析與優化建議.md)
- [前端重構計劃 (docs/refactor_docs/0405前端重構計劃.md)](./0405前端重構計劃.md)

---

## 路線一：穩固陣地，提升即時互動體驗

**目標：** 快速解決影響使用者體驗的效能瓶頸，確保基礎互動流暢。

**參考：**
- [效能問題分析](./0402前端效能問題分析與優化建議.md)
- [重構計劃第一期](./0405前端重構計劃.md#:~:text=第一期：即時效能提升與基礎重構)

**待辦事項：**

-   [x] **記憶體洩漏修復：**
    -   [x] 確保 WebSocket 連線在組件卸載時正確調用 `disconnect()` ([參考](./0402前端效能問題分析與優化建議.md#:~:text=WebSocket%20連線未適時關閉))。
    -   [x] 實現 3D 模型切換時，舊模型資源 (geometry, material, texture) 的 `dispose()` ([參考](./0402前端效能問題分析與優化建議.md#:~:text=3D%20模型資源未釋放))。 *(註：已加入 dispose 邏輯，但存在 linter 誤報，需手動確認)*
-   [x] **減少不必要的 React 重繪：**
    -   [x] 將聊天列表的 `key` 從索引改為唯一 ID ([參考](./0402前端效能問題分析與優化建議.md#:~:text=列表項目使用不穩定的%20key))。
    -   [x] 優化 Morph Target 更新機制，減少經由 React `setState` 的頻率 ([參考](./0402前端效能問題分析與優化建議.md#:~:text=Morph%20Target%20狀態頻繁更新))。
    -   [x] 分析 `ControlPanel` 和 `ModelViewer` 的 props 傳遞，使用 `React.memo` 和 `useCallback` 優化 ([參考](./0405前端重構計劃.md#:~:text=減少不必要的%20React%20重繪))。
    -   [x] 檢查 `useAudioService` 和 `useChatService` 返回狀態的引用穩定性，並優化 `useChatService` 中的 `emotion` 更新邏輯 ([參考](./0405前端重構計劃.md#:~:text=減少不必要的%20React%20重繪))。
-   [ ] **渲染迴圈優化：**
    -   [ ] 將高頻動畫更新 (如嘴型同步插值、表情平滑過渡) 移入 R3F 的 `useFrame` Hook 處理 ([參考](./0405前端重構計劃.md#:~:text=使用%20useFrame%20Hook))。
    -   [ ] 研究並視情況使用 R3F 的 `frameloop="demand"` 或 `invalidate()` 來控制閒置時的渲染 ([參考](./0405前端重構計劃.md#:~:text=暫停未使用的動畫迴圈))。
-   [ ] **動畫與計時器管理：**
    -   [ ] 確保 WebSocket 重連計時器在成功連線後被清除 ([參考](./0402前端效能問題分析與優化建議.md#:~:text=WebSocket%20重連計時器))。
    -   [ ] 確保本地備用嘴型動畫 (Interval) 在接收到即時 Lipsync 數據時暫停 ([參考](./0402前端效能問題分析與優化建議.md#:~:text=過多同時進行的動畫))。
-   [ ] **基礎資源管理：**
    -   [ ] 審查 3D 資源加載，確保使用 `useMemo` 或 R3F Loader 快取機制，避免重複創建 ([參考](./0405前端重構計劃.md#:~:text=物件重用與記憶體優化))。

---

## 路線二：重塑骨架，奠定可擴展架構

**目標：** 引入現代化狀態管理，重構組件與服務，建立清晰、低耦合的架構基礎。

**參考：**
- [現有前端架構](../前端相關/0402前端架構.md)
- [重構計劃第二期](./0405前端重構計劃.md#:~:text=第二期：代碼模組化與維護性改進)
- [重構計劃第三期](./0405前端重構計劃.md#:~:text=第三期：引入集中式狀態管理與架構優化)

**待辦事項：**

-   [ ] **引入 Zustand 狀態管理：**
    -   [ ] 添加 Zustand 依賴。
    -   [ ] 創建全局 Store，定義核心狀態切片 (slices)，如 `useAppStore`, `useAvatarStore` ([參考](./0405前端重構計劃.md#:~:text=導入%20Zustand%20作為全域狀態儲存))。
    -   [ ] 逐步將原有 Context 或服務管理的全局狀態遷移至 Zustand。
-   [ ] **組件拆分與模組化：**
    -   [ ] 拆分大型組件，如將 `App.tsx` 中的 3D 場景 (`<AvatarScene>`) 和控制面板 (`<ControlPanel>`) 抽離 ([參考](./0405前端重構計劃.md#:~:text=拆分大型組件))。
    -   [ ] 審查 `src/` 目錄結構，確保模組職責單一 ([參考](./0405前端重構計劃.md#:~:text=整理目錄結構))。
-   [ ] **服務層解耦：**
    -   [ ] 調整服務 (WebSocket, Chat, Audio, Model) 與狀態的互動模式，使其透過更新 Zustand store 來觸發前端變化，而非直接調用其他模組 ([參考](./0405前端重構計劃.md#:~:text=調整服務層與狀態的互動))。
    -   [ ] 考慮服務實例的提供方式 (Context 或依賴注入)，降低直接 import 全局單例的耦合度 ([參考](./0405前端重構計劃.md#:~:text=服務層單元化))。
-   [ ] **建立清晰分層：**
    -   [ ] 明確 UI 層、狀態層 (Zustand)、服務/控制層的職責與交互方式 ([參考](./0405前端重構計劃.md#:~:text=引入更佳架構模式))。
-   [ ] **類型與註解：**
    -   [ ] 在重構過程中，確保 TypeScript 類型定義清晰，並為新模組添加必要的 JSDoc 註解 ([參考](./0405前端重構計劃.md#:~:text=增強類型與文件註解))。

### 2.4 引入狀態管理（Zustand）的基礎準備
- [ ] 確保組件之間共享狀態的介面清晰。
- [ ] 考慮將某些全域狀態轉移到 React Context 或 hook (作為過渡)。

### 2.5 增強類型與文件註解
- [ ] 為重構後的模組補充清晰的 TypeScript 型別定義。
- [ ] 為主要模組添加必要的註解。

### 2.6 其他代碼清理與 Bug 修復 (第二期)
- [X] 修復 `App.tsx` 中移除 `morphTargetInfluences` 後引入的 Linter 錯誤 (涉及 `ModelViewer`, `Model`)。
- [X] 修正 `Model.tsx` 中 `logger.info`/`logger.debug` 的參數類型錯誤。
- [X] 解決模型切換後新模型不播放動畫的問題：
    - [X] `ModelService` 添加 `switchModel` 方法，並在切換時重置相關狀態。
    - [X] `Model.tsx` 確保 `key={url}` 存在，並優化預設動畫播放邏輯 (嘗試 Idle 或第一個可用動畫)。
    - [X] 修復 `ModelService` 中的 Linter 錯誤 (重複回調)。
- [ ] ... (其他待發現或待處理的清理任務)

## 第三期：引入集中式狀態管理與架構優化

**目標：** 導入 Zustand 管理應用狀態，優化架構，為「頭部表情」與「身體動畫」獨立控制做準備。

### 3.1 導入 Zustand
- [ ] 新增 Zustand 並建立全局 store (`useAppStore`, `useAvatarStore` 等)。
- [ ] 定義狀態切片 (slices) 和 actions。
- [ ] 逐步將 Context 或 service 中的狀態遷移到 Zustand store。

## 路線三：賦予靈魂，解耦精細動畫控制

**目標：** 分離頭部/表情與身體動畫控制，實現更細膩、靈活的角色表現。

**參考：**
- [重構計劃第四期](./0405前端重構計劃.md#:~:text=第四期：頭部表情與身體動畫控制拆分)

**待辦事項：**

-   [ ] **設計動畫控制器接口：**
    -   [ ] 定義 `HeadAnimationController` 的接口 (如 `setExpression`, `update`)。
    -   [ ] 定義 `BodyAnimationController` 的接口 (如 `playAnimation`, `update`) ([參考](./0405前端重構計劃.md#:~:text=設計動畫控制模組接口))。
-   [ ] **實現動畫控制器：**
    -   [ ] 實作 `HeadAnimationController`，處理 Morph Target 控制、表情平滑過渡 ([參考](./0405前端重構計劃.md#:~:text=表情控制器實作細節))。
    -   [ ] 實作 `BodyAnimationController`，處理骨骼動畫播放、混合 (可利用 `AnimationMixer` 或 Drei 的 `useAnimations`) ([參考](./0405前端重構計劃.md#:~:text=身體控制器實作細節))。
-   [ ] **整合控制器：**
    -   [ ] 修改 `ModelService` 或相關 3D 組件，初始化並使用這兩個控制器 ([參考](./0405前端重構計劃.md#:~:text=集成控制器至主流程))。
    -   [ ] 在渲染迴圈 (`useFrame`) 中調用兩個控制器的 `update` 方法。
-   [ ] **狀態驅動動畫：**
    -   [ ] 讓控制器監聽 Zustand store 中的相關狀態 (如 `currentEmotion`, `targetAnimation`)。
    -   [ ] 確保狀態變化能正確觸發對應的控制器方法 ([參考](./0405前端重構計劃.md#:~:text=與狀態管理整合))。
-   [ ] **協調與測試：**
    -   [ ] 測試表情和身體動畫同時進行的效果，確保協調自然 ([參考](./0405前端重構計劃.md#:~:text=表情與動作協調處理))。

## 路線四：精兵簡政，保障長期發展

**目標：** 清理技術負債，統一規範，完善文檔與測試，確保專案長期健康。

**參考：**
- [重構計劃第五期](./0405前端重構計劃.md#:~:text=第五期：技術負債清理與最終優化)
- [專案總覽與願景 (README.md)](../../README.md)

**待辦事項：**

-   [ ] **代碼清理：**
    -   [ ] 移除因重構產生的冗餘代碼、註解、舊的狀態管理方式 (如 Context) ([參考](./0405前端重構計劃.md#:~:text=移除冗餘代碼與註解))。
    -   [ ] 移除不再使用的 `console.log`。
-   [ ] **規範統一：**
    -   [ ] 執行 ESLint 和 Prettier，確保所有程式碼風格一致 ([參考](./0405前端重構計劃.md#:~:text=統一代碼風格))。
    -   [ ] 檢查並統一命名規範。
-   [ ] **依賴管理：**
    -   [ ] 審查 `package.json`，更新核心依賴 (React, R3F, Zustand 等) 到穩定新版本 ([參考](./0405前端重構計劃.md#:~:text=更新依賴與版本))。
    -   [ ] 移除未使用的依賴。
-   [ ] **構建與加載優化：**
    -   [ ] 檢查 3D 模型大小，考慮壓縮 (Draco) 或優化 ([參考](./0405前端重構計劃.md#:~:text=優化構建與加載))。
    -   [ ] 利用 Vite 的代碼分割優化初始加載時間。
    -   [ ] 使用 Bundle Analyzer 分析打包結果。
-   [ ] **健壯性提升：**
    -   [ ] 審查並完善錯誤處理邏輯 (API, WebSocket) ([參考](./0405前端重構計劃.md#:~:text=強化錯誤處理與日誌))。
    -   [ ] 在關鍵流程添加必要的日誌記錄。
-   [ ] **文檔更新：**
    -   [ ] 更新 [README.md](../../README.md) 中的架構圖和說明，反映重構後的狀態。
    -   [ ] 為新的核心模組 (如控制器、Zustand store) 補充文檔說明 ([參考](./0405前端重構計劃.md#:~:text=文件維護))。
-   [ ] **(可選) 測試覆蓋：**
    -   [ ] 為核心狀態邏輯 (Zustand actions/reducers) 編寫單元測試 ([參考](./0405前端重構計劃.md#:~:text=編寫測試))。
    -   [ ] 考慮為關鍵交互流程編寫整合測試。
-   [ ] **最終驗收：**
    -   [ ] 進行全面的功能回歸測試。
    -   [ ] 進行效能和壓力測試，確保達到預期目標 ([參考](./0405前端重構計劃.md#:~:text=性能回歸檢查))。

- [ ] **減少不必要的 React 重繪 (次要):** 檢查其他高頻更新是否可以移出 React state。
    - [ ] 分析 `AudioService` 中的狀態更新 (`isRecording`, `isSpeaking`, `isProcessing`) 是否觸發過多重繪，考慮是否能用 ref 或其他方式優化 (可能不需要，優先級低)。

- [ ] **實現基礎的錯誤處理和日誌記錄:**
    - [ ] 在WebSocket連接、消息發送/接收、API調用等關鍵點添加日誌記錄。
    - [ ] 考慮添加一個簡單的錯誤邊界組件 (Error Boundary)。

- [ ] **程式碼清理和註釋 (持續進行):**
    - [ ] 移除不再使用的程式碼片段。
    - [ ] 添加或更新必要的註釋，解釋複雜邏輯。

- [ ] **最終測試和驗證:**

### 5.6 編寫測試
- [ ] 為核心功能撰寫單元測試或整合測試 (狀態管理、控制器、服務交互)。

### 5.7 其他代碼清理與 Bug 修復 (第五期)
- [ ] 審查並移除所有不再使用的代碼、註解、日誌。
- [ ] 解決所有 ESLint/TypeScript 警告。
- [ ] ... (其他待發現或待處理的清理任務)
