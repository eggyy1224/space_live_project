# 角色主動性 (Agentic Capability - Murmur) 開發待辦事項

本文件追蹤為實現角色主動發起「內心 murmur」功能所需的後端開發任務。目標是在不修改前端 API 的前提下，利用現有 WebSocket 通道實現此功能。

## 後端修改

1.  **`websocket.py` - 加入閒置偵測邏輯：**
    *   [ ] 在 `websocket_endpoint` 函式中，為每個 WebSocket 連線增加閒置計時器。
    *   [ ] 記錄每個連線的 `last_activity_timestamp`。
    *   [ ] 建立一個背景協程 (`idle_checker`) 定期檢查閒置時間是否超過閾值 (例如 30 秒)。
    *   [ ] 確保在收到前端訊息或後端主動發送訊息後，重置 `last_activity_timestamp`。

2.  **`websocket.py` - 觸發 Murmur 生成與處理：**
    *   [ ] 當閒置超時，調用 `ai_service.generate_response`。
    *   [ ] 傳遞 `user_input=None` 以及一個特定的 `system_prompt` (例如："生成一句內心獨白") 給 `ai_service`。
    *   [ ] 接收 `ai_service` 返回的 murmur 文字 (包含由 LLM 分析的情緒)。
    *   [ ] 使用 `tts_service.synthesize_speech` 將 murmur 文字轉換為語音。

3.  **`websocket.py` - 推送 Murmur 訊息至前端：**
    *   [ ] 將生成的 murmur 文字、情緒、語音 (base64)、時長、角色狀態等打包成 JSON。
    *   [ ] **重要：** 使用前端已知的訊息類型，例如 `"type": "response"`。
    *   [ ] 使用 `websocket.send_json()` 將打包好的訊息推送給前端。

4.  **`services/ai/` (`AIService` 或相關模組) - 支援 Murmur 生成模式：**
    *   [ ] 確保 `generate_response` 方法或其內部的 `DialogueGraph` 能夠處理 `user_input=None` 且僅依賴 `system_prompt` 的情況。
    *   [ ] 調整提示詞工程或對話圖邏輯，以生成符合情境的「內心 murmur」。

## 前端修改

*   [x] 無需修改 (目標是重用現有 WebSocket 接收和處理邏輯)。

## 測試

*   [ ] 測試閒置超時是否能正確觸發 murmur 生成。
*   [ ] 測試生成的 murmur 內容、情緒、語音是否符合預期。
*   [ ] 確認前端能像接收一般回應一樣，正確顯示 murmur 文字、播放語音、更新表情。
*   [ ] 測試連續閒置時，murmur 不會過於頻繁地觸發。

## 角色主動互動功能實現任務清單

本文件列出了為 Space Live Project 實現虛擬主播主動互動能力所需完成的任務。此功能將使虛擬角色在使用者長時間未輸入時，能夠主動發起對話以保持互動流暢性，並展現出具有個性化的角色特點和自然的行為模式。

## 系統架構概述

主動互動功能的核心理念是使AI虛擬角色具備自主性，能夠根據:
- 時間流逝（閒置時間）
- 角色的性格設定
- 當前情緒狀態
- 時間點（早晨、中午、晚上等）
- 特殊日期（節日、紀念日）

在適當的時機主動與用戶互動，展現出類似真人的行為模式和情感波動。

系統將由以下幾個主要部分組成：
1. **狀態監控系統** - 追蹤用戶活動和時間變化
2. **角色性格系統** - 定義角色的個性和行為偏好
3. **主動對話系統** - 生成並管理主動發起的對話
4. **情緒管理系統** - 控制角色情緒變化和表現
5. **時間感知系統** - 基於時間觸發不同類型的互動

## 後端任務

### 新增模組

- [ ] **閒置監控模組 (IdleMonitor)**
  - 建立 `backend/services/ai/idle_monitor.py`
  - 實現計時器邏輯，追蹤每個連線的最後活動時間
    - 設計連線 ID 與最後活動時間的映射結構
    - 實現原子更新機制，避免競態條件
  - 提供判斷閒置狀態的機制
    - 比較當前時間與最後活動時間的差值
    - 支援多種閒置條件（絕對時間、相對時間）
  - 支持可配置的閒置時間閾值
    - 從配置文件讀取閾值設定
    - 提供運行時調整閾值的介面
  - 優化考量
    - 實現閒置檢測的效能優化，避免頻繁時間計算
    - 設計階梯式閒置觸發（短閒置、中閒置、長閒置）
    - 添加隨機因子，避免機械式的固定間隔觸發

- [ ] **話題生成模組 (TopicGenerator)**
  - 建立 `backend/services/ai/topic_generator.py`
  - 初期實現：預設話題庫和選取機制
    - 建立分類話題庫（太空科學、日常閒聊、用戶互動等）
    - 實現加權隨機選取演算法
    - 支援話題新鮮度跟踪，避免短期內重複話題
  - 中期優化：上下文感知的話題生成
    - 分析最近對話歷史，提取可能的話題線索
    - 實現話題連貫性規則，使新話題與前文相關
    - 增加話題轉換自然度的處理機制
  - 高級功能：記憶整合的個性化話題
    - 整合用戶興趣模型，優先選擇用戶感興趣的話題
    - 實現特殊事件觸發的話題（如首次見面、再次相見等）
    - 基於 AI 生成的動態話題創建能力
  - 其他功能
    - 話題優先級排序系統
    - 季節性/時令話題庫更新機制
    - 話題效果反饋機制（記錄哪些話題獲得較好反應）

- [ ] **主動對話管理器 (ProactiveDialogueManager)**
  - 建立 `backend/services/ai/proactive_dialogue_manager.py`
  - 協調各模組，處理從閒置檢測到回應生成的流程
    - 定義觸發條件評估邏輯
    - 實現多來源觸發的優先級處理（時間觸發 vs 情緒觸發）
    - 設計模組間的事件通知機制
  - 實現對話頻率控制，避免過度打擾用戶
    - 建立衰減機制，隨著主動對話次數增加而延長間隔
    - 實現用戶反應分析，根據用戶參與度調整頻率
    - 添加「Do Not Disturb」時段配置
  - 回應生成與分發
    - 協調 AI 服務生成適合當前情境的回應
    - 處理回應裝飾（添加表情符號、語氣詞等）
    - 實現回應排隊機制，確保訊息發送順序合理
  - 統計與分析
    - 記錄主動對話的觸發原因、時間和效果
    - 提供調試介面，便於開發階段分析主動行為

- [ ] **角色性格管理模組 (PersonaProfile)**
  - 建立 `backend/services/ai/persona_profile.py`
  - 定義角色的性格模型和背景故事
    - 建立多維度性格特質系統（外向性、開放性、情緒穩定性等）
    - 定義詳細的背景故事、專業知識和個人歷史
    - 實現角色價值觀和道德準則的數字化表示
  - 設計性格特質的數值表示系統
    - 建立 1-10 範圍的量化指標
    - 定義核心性格特質與次要特質的層次結構
    - 實現基於情境的特質優先權系統
  - 提供性格融入對話生成的機制
    - 建立性格特質與語言風格的映射關係
    - 設計性格驅動的措辭選擇系統
    - 實現角色特有的語言習慣和口頭禪
  - 身份管理
    - 定義專業領域知識庫
    - 建立角色關心的話題和興趣領域列表
    - 實現角色偏好的參考資料和知識來源

- [ ] **情緒引擎模組 (EmotionEngine)**
  - 建立 `backend/services/ai/emotion_engine.py`
  - 設計情緒狀態管理系統
    - 定義基礎情緒狀態（快樂、悲傷、驚訝、憤怒等）
    - 建立情緒強度的量化表示（1-10）
    - 實現情緒組合與混合狀態（如期待=快樂+緊張）
  - 實現情緒動態變化機制
    - 設計情緒衰減模型，使情緒隨時間自然變化
    - 建立基於對話內容的情緒觸發規則
    - 實現情緒慣性和閾值系統
  - 建立情緒與行為的關聯機制
    - 情緒狀態與對話風格的映射
    - 情緒驅動的主動行為傾向（快樂時更傾向分享）
    - 極端情緒下的特殊行為處理
  - 情緒表達系統
    - 語氣詞和情緒標記的使用規則
    - 表情和動作建議生成
    - 情緒相容性檢查，確保情緒表達與內容協調

- [ ] **行為排程器 (BehaviorScheduler)**
  - 建立 `backend/services/ai/behavior_scheduler.py`
  - 設計基於時間的行為模式系統
    - 定義一日行程表（早晨問候、午餐時間、晚間閒聊等）
    - 建立工作日與週末的差異化行為模式
    - 實現行為時段的動態調整（根據用戶活躍時間）
  - 實現特殊時間點和日期的行為觸發
    - 節日和特殊日期的檢測與行為匹配
    - 紀念日和重要事件的記憶與回顧機制
    - 實現倒計時提醒和「今日推薦」功能
  - 建立行為優先級管理系統
    - 設計行為衝突解決策略
    - 實現緊急事件優先級提升機制
    - 建立用戶中斷時的行為暫停與恢復邏輯
  - 時間感知功能
    - 實現基於地理位置的時區處理
    - 季節感知與天氣響應能力
    - 長期行為規劃（週計劃、月計劃）

### 修改現有模組

- [ ] **WebSocket 控制器**
  - 修改 `backend/api/endpoints/websocket.py`
  - 整合閒置監控功能
    - 在連線建立時初始化 IdleMonitor
    - 實現用戶活動時間更新邏輯
    - 設置閒置檢查的背景任務
  - 實現主動訊息推送機制
    - 建立訂閱機制接收主動對話事件
    - 實現訊息格式轉換和封裝
    - 添加訊息發送失敗的重試機制
  - 優化連線管理，確保資源高效使用
    - 實現連線池管理和資源回收
    - 建立連線狀態監控與恢復機制
    - 優化長連線維護策略

- [ ] **AI 服務**
  - 修改 `backend/services/ai/__init__.py` 或 `backend/services/ai/service.py`
  - 擴充服務介面支持主動對話生成
    - 添加無用戶輸入的對話生成入口
    - 擴展參數接口，支持不同場景的提示詞生成
    - 實現流式生成與非流式生成的統一接口
  - 優化提示詞構建，適應不同對話場景
    - 設計多層次提示詞模板系統
    - 實現上下文敏感的提示詞生成
    - 建立提示詞效果評估與優化機制
  - 整合角色性格和情緒系統
    - 在提示詞中注入性格和情緒信息
    - 實現回應後處理，確保符合性格和情緒特徵
    - 建立回應質量檢查機制

- [ ] **資料模型**
  - 修改 `backend/core/models.py` 或 `backend/dtos/responses.py`
  - 擴充消息類型，支持主動訊息識別
    - 添加消息類型枚舉（用戶訊息、回應訊息、主動訊息）
    - 擴充訊息元數據，包含觸發原因和情境信息
    - 實現訊息分類與過濾機制
  - 設計角色狀態數據模型
    - 定義情緒狀態結構
    - 建立性格特質的數據表示
    - 實現狀態持久化和序列化

## 前端任務

### 修改現有模組

- [ ] **WebSocket 服務**
  - 修改 `frontend/src/services/WebSocketService.ts`
  - 增強接收和處理主動訊息的能力
    - 添加主動訊息的專用處理器
    - 實現訊息類型識別與路由
    - 建立訊息優先級處理機制
  - 確保連線重建後功能正常恢復
    - 實現重連邏輯與狀態恢復
    - 建立心跳檢測機制
    - 添加斷線狀態的視覺反饋

- [ ] **聊天服務**
  - 修改 `frontend/src/services/ChatService.ts`
  - 設計主動訊息的接收和顯示邏輯
    - 實現主動訊息的視覺區分方案
    - 建立訊息顯示的動畫效果
    - 設計用戶未讀訊息的提示機制
  - 整合音頻和視覺反饋系統
    - 實現訊息類型與動畫效果的映射
    - 建立訊息與音頻播放的協調機制
    - 設計情緒表達與表情切換的流暢過渡

- [ ] **狀態管理**
  - 修改狀態管理相關文件
  - 擴充狀態模型，支持角色情緒和行為狀態
    - 添加角色當前情緒狀態的存儲
    - 實現行為模式和活動狀態的跟踪
    - 建立狀態變化的歷史記錄
  - 優化狀態更新流程，確保UI反饋一致性
    - 設計基於狀態機的UI更新機制
    - 實現樂觀更新與回滾機制
    - 建立狀態變化的訂閱與通知系統

- [ ] **虛擬角色動畫控制**
  - 修改虛擬角色相關組件
  - 擴充表情和動作系統
    - 增加基礎情緒對應的表情動畫
    - 建立複合表情生成機制
    - 實現表情強度的可調節控制
  - 實現基於情緒和行為的動畫變化
    - 建立情緒狀態與動畫參數的映射
    - 設計動作庫與動作組合系統
    - 實現閒置狀態下的隨機動作生成
  - 動畫精細化
    - 實現說話時的口型同步
    - 添加注視和頭部跟踪功能
    - 建立手勢和肢體語言的表達系統

## 角色設計任務

- [ ] **角色人格設計文檔**
  - 建立 `docs/設計相關/角色人格設定.md`
  - 定義角色背景故事和世界觀
    - 撰寫角色的起源、經歷和重要事件
    - 建立角色所處的世界設定和宇宙觀
    - 定義角色的人際關係網絡
  - 設計性格特質和表達風格
    - 描述核心性格特點（如開朗、認真、好奇等）
    - 定義說話風格和語言特徵
    - 設計性格中的矛盾點和成長空間
  - 建立專業知識領域和興趣偏好
    - 列舉角色擅長的領域和話題
    - 定義角色的興趣愛好和休閒活動
    - 設計專業知識表達的深度和通俗化能力

- [ ] **日常行為模式設計**
  - 建立 `docs/設計相關/角色日常行為.md`
  - 設計角色的時間作息和行為模式
    - 創建詳細的日程表（早晨例行、工作時間、休息時間等）
    - 定義工作日與假日的不同行為模式
    - 設計角色的個人習慣和儀式感行為
  - 定義時段相關的互動特點
    - 不同時段的對話主題和語氣變化
    - 特殊時段的專屬行為（如早安問候、晚安道別）
    - 時段轉換時的過渡行為
  - 規劃特殊日期的獨特表現
    - 節日和紀念日的特殊互動設計
    - 生日和週年的慶祝方式
    - 季節性話題和活動的規劃

- [ ] **情緒變化規則設計**
  - 建立 `docs/設計相關/角色情緒系統.md`
  - 定義基礎情緒狀態及其表現
    - 列舉核心情緒（喜悅、悲傷、憤怒、恐懼等）
    - 描述每種情緒的外在表現特徵
    - 設計情緒強度的分級標準
  - 設計情緒變化的觸發機制
    - 定義對話內容的情緒影響規則
    - 設計環境和時間因素的情緒效應
    - 建立情緒觸發的閾值和權重系統
  - 建立情緒平衡和恢復系統
    - 設計情緒衰減曲線和恢復時間
    - 定義極端情緒的自我調節機制
    - 建立長期情緒基線和性格相關的情緒傾向

## 測試任務

- [ ] **後端單元測試**
  - 各模組功能的獨立測試
    - 為每個核心模組設計專用測試案例
    - 實現參數邊界測試和異常處理測試
    - 建立模組間交互的 mock 測試
  - 確保核心邏輯穩定可靠
    - 實現自動化持續集成測試
    - 設計性能和負載測試
    - 建立回歸測試套件

- [ ] **整合測試**
  - 端到端流程測試
    - 設計完整的用戶場景測試案例
    - 實現多模組協作的集成測試
    - 建立長時間運行的穩定性測試
  - 驗證各系統間的協作正常
    - 模擬不同觸發條件下的系統反應
    - 測試極端情況和邊界條件
    - 實現多用戶並發場景測試

- [ ] **使用者體驗測試**
  - 互動自然度和流暢度測試
    - 設計主觀評估量表和指標
    - 組織用戶測試小組和反饋收集
    - 實施 A/B 測試比較不同實現方案
  - 角色表現的真實感評估
    - 測試角色情緒表達的一致性
    - 評估性格特質在互動中的體現程度
    - 檢測行為模式的自然度和可信度
  - 用戶反饋收集和分析
    - 設計用戶滿意度調查問卷
    - 建立長期用戶參與度追蹤
    - 實施定期功能優化評估

## 實作階段

### 第一階段：基礎實現

1. 實現閒置檢測和基本主動對話框架
   - 建立 IdleMonitor 閒置檢測基本功能
   - 實現 WebSocket 連接的活動追蹤
   - 搭建主動對話的基本消息推送架構
   - 前端實現接收和顯示主動消息的基礎功能

2. 建立簡單的話題生成系統
   - 創建基礎話題庫，分類組織
   - 實現隨機話題選取邏輯
   - 設計簡單的話題適用性判斷

3. 設計基本角色性格和情緒系統
   - 定義角色基本性格特質和背景故事
   - 建立簡單的情緒狀態模型
   - 實現基礎性格特質在對話中的體現

4. 完成訊息傳遞和顯示的基礎功能
   - 擴展消息類型支持主動訊息
   - 實現主動訊息在UI中的基本顯示
   - 建立簡單的音頻和表情反饋

5. 驗證基本功能可正常工作
   - 進行初步端到端測試
   - 收集並修復基本功能缺陷
   - 調整觸發頻率和反應時間

### 第二階段：角色豐富化

1. 完善角色性格和專業知識體系
   - 擴充角色性格的多維度表達
   - 建立專業知識庫和參考資料
   - 優化性格特質在對話中的自然表現

2. 增強情緒管理系統的深度和廣度
   - 實現更複雜的情緒變化規則
   - 完善情緒強度和持續時間的控制
   - 優化情緒與表達方式的匹配

3. 實現基於時間的行為模式
   - 建立完整的日程表系統
   - 實現特殊時間點的行為觸發
   - 設計時段轉換的自然過渡行為

4. 豐富主動互動的內容和形式
   - 擴充話題庫並提高話題相關性
   - 優化話題選擇的上下文感知能力
   - 實現多種主動互動模式（問候、分享、詢問）

5. 優化前端動畫和表情表現
   - 增加更多情緒表達的視覺元素
   - 實現說話和情緒的流暢動畫過渡
   - 添加閒置狀態下的自然動作

### 第三階段：進階功能

1. 多元觸發條件的主動互動
   - 實現基於用戶行為模式的觸發機制
   - 添加環境感知和事件響應能力
   - 設計多條件組合的智能觸發系統

2. 記憶系統與對話的緊密整合
   - 實現長期記憶與短期記憶的分層結構
   - 優化記憶檢索與話題關聯
   - 設計記憶衰減和重要事件強化機制

3. 情緒系統的自然過渡和表現
   - 實現情緒混合和漸變效果
   - 優化情緒持續時間和強度變化
   - 設計情緒與角色性格的協調機制

4. 時間和節日感知的特殊行為
   - 實現完整的日期特殊事件系統
   - 設計節日和紀念日的特殊互動
   - 優化季節性話題和活動推薦

5. 整體系統的性能優化和穩定性提升
   - 優化資源使用和響應速度
   - 實現錯誤恢復和異常處理機制
   - 完善監控和日誌系統

## 注意事項

1. 主動互動頻率應適中，避免對用戶造成打擾
   - 實測理想的初始觸發間隔為3-5分鐘
   - 考慮基於用戶反應動態調整頻率
   - 提供用戶自定義頻率的選項

2. 角色的性格表現應保持一致性，避免違和感
   - 確保所有模組對角色性格的理解一致
   - 對極端情況下的行為進行特殊處理
   - 定期審查對話記錄確保性格表現穩定

3. 情緒變化應自然流暢，不宜有劇烈跳躍
   - 除特殊事件外，情緒變化應漸進而非突變
   - 關注情緒強度和持續時間的平衡
   - 實施情緒狀態的歷史記錄和趨勢分析

4. 主動對話應考慮當前場景和上下文，保持連貫性
   - 確保新話題與前文存在合理關聯
   - 實施主動對話前的上下文檢查
   - 避免在用戶沉浸於特定任務時打斷

5. 系統資源使用應高效，特別是長時間運行的後台任務
   - 優化閒置檢測的計算方式，避免頻繁喚醒
   - 實施資源使用監控和異常報警
   - 考慮分散式部署以提高穩定性

## 預期成果

成功實現後，虛擬主播將具備自然且富有個性的互動能力，能在適當時機主動與用戶互動，表現出基於時間、情境和自身性格的多樣行為。這將顯著提升用戶體驗，使互動更加自然流暢，增強用戶與虛擬角色間的情感連接，打造更具沉浸感和真實感的互動體驗。 

具體成果包括：
- 在用戶閒置3-5分鐘後，角色能自然地開啟新話題
- 虛擬主播能根據一天中的不同時段展現不同的行為模式
- 角色情緒會隨著互動內容自然變化並影響表達方式
- 在特殊日期（如節日），角色會主動提及並展現應景行為
- 長期互動中，角色能記住並引用過往對話中的重要內容
- 角色表現出一致且富有深度的性格特徵，增強用戶連接感 